import React, { useState, useEffect } from "react";
import { toast } from "sonner";
import axios from "axios"

export default function NotesInput({ onAddNotes, initialTitle, initialBody, initialImage }) {
  const [title, setTitle] = useState("");
  const [body, setBody] = useState("");
  let maxCharTitle = 50;
  const [limitChar, setLimitChar] = useState(maxCharTitle);
  const [image, setImage] = useState(null);
  const supportedImageFormats = ['image/png', 'image/jpeg', 'image/jpg'];

  function handleSubmit(e) {
    e.preventDefault();

    if (title && body) {
      onAddNotes({ title, body, image });
      setTitle("");
      setBody("");
      setImage(null);
      setLimitChar(maxCharTitle);
    } else {
      toast('All fields are required!')
    }
  }

  function handleChange(e) {
    const newTitle = e.target.value;
    if (newTitle.length <= maxCharTitle) {
      setTitle(newTitle);
      setLimitChar(maxCharTitle - newTitle.length);
    }
  }

  useEffect(() => {
    setTitle(initialTitle ? initialTitle : "");
    setBody(initialBody ? initialBody : "");
    setImage(initialImage ? initialImage : null);
    setLimitChar(maxCharTitle - initialTitle.length);
  }, [initialTitle, initialBody, initialImage]);

  const uploadToCloudinary = async (file) => {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "m9xeajl4"); // Replace with your upload preset

    try {
      const response = await axios.post(
        "https://api.cloudinary.com/v1_1/dymxghqum/image/upload",
        formData
      ); // Replace with your Cloudinary cloud name
      return response.data.secure_url;
    } catch (error) {
      console.error("Error uploading to Cloudinary:", error);
      return null;
    }
  };

  const handleFileChange = async (event) => {
    if (event.target.files && event.target.files[0]) {
      const file = event.target.files[0];
      if (!supportedImageFormats.includes(file.type)) {
        toast(
          "Unsupported image format. Please upload a PNG, JPG, or JPEG file."
        );
        return;
      }
      const uploadedUrl = await uploadToCloudinary(file);
      if (uploadedUrl) {
        setImage(uploadedUrl);
      }
    }
  };

  const handleDragOver = (event) => {
    event.preventDefault();
  };

  const handleDrop = async (event) => {
    event.preventDefault();
    const file = event.dataTransfer.files[0];
    if (file) {
      if (!supportedImageFormats.includes(file.type)) {
        toast(
          "Unsupported image format. Please upload a PNG, JPG, or JPEG file."
        );
        return;
      }
      const uploadedUrl = await uploadToCloudinary(file);
      if (uploadedUrl) {
        setImage(uploadedUrl);
      }
      // setImage(URL.createObjectURL(file));
    }
  };

  return (
    <>
      <form onSubmit={handleSubmit}>
        <p className="note-input__title__char-limit">
          Remaining Characters: {limitChar}
        </p>
        <input
          type="text"
          className="note-input__title"
          placeholder="Title..."
          onChange={handleChange}
          value={title}
        />
        <textarea
          className="note-input__body"
          rows={4}
          placeholder="Write your note here ..."
          value={body}
          onChange={(e) => setBody(e.target.value)}
        ></textarea>

        <div
          className="mx-auto mx-sm-0 mb-3"
          style={{ width: "100%", maxwidth: "100%", maxHeight: "120px",
          border: '1px dashed #888', borderRadius: '8px' }}
        >
          <div
            className="imgDrop_zone"
            onDragOver={handleDragOver}
            onDrop={handleDrop}
            style={{ minHeight: "120px" }}
          >
            <div className="dz_background">
              <svg
                width="171"
                height="116"
                viewBox="0 0 171 116"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className="w-100 h-100"
              >
                <rect
                  x="0.945583"
                  y="0.394558"
                  width="169.66"
                  height="115.211"
                  rx="12.64879"
                  fill="transparent"
                  stroke="transparent"
                  strokeWidth="0.789116"
                  strokeDasharray="3.62 3.62"
                />

                {!image && (
                  <>
                    <path
                      fillRule="evenodd"
                      clipRule="evenodd"
                      d="M68.0666 29.4531C68.0666 28.4521 68.8781 27.6406 69.8791 27.6406H101.598C102.599 27.6406 103.41 28.4521 103.41 29.4531V61.1719C103.41 62.1729 102.599 62.9844 101.598 62.9844H69.8791C68.8781 62.9844 68.0666 62.1729 68.0666 61.1719V29.4531Z"
                      stroke="#D1D5DB"
                      strokeWidth="1.8125"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                    <path
                      fillRule="evenodd"
                      clipRule="evenodd"
                      d="M78.8661 41.3857C80.4928 41.3857 81.8115 40.0671 81.8115 38.4404C81.8115 36.8138 80.4928 35.4951 78.8661 35.4951C77.2395 35.4951 75.9208 36.8138 75.9208 38.4404C75.9208 40.0671 77.2395 41.3857 78.8661 41.3857Z"
                      stroke="#D1D5DB"
                      strokeWidth="1.8125"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                    <path
                      d="M103.41 51.2034L93.5925 41.3857L71.9936 62.9847"
                      stroke="#D1D5DB"
                      strokeWidth="1.8125"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                    <path
                      d="M59.3119 73.0163H58.3079C58.2692 72.8017 58.1974 72.6129 58.0922 72.4499C57.9871 72.2868 57.8584 72.1484 57.706 72.0347C57.5537 71.921 57.3831 71.8352 57.1943 71.7773C57.0077 71.7193 56.8092 71.6904 56.599 71.6904C56.2192 71.6904 55.8792 71.7859 55.5788 71.9768C55.2806 72.1678 55.0446 72.4477 54.8708 72.8168C54.6992 73.1858 54.6133 73.6363 54.6133 74.1684C54.6133 74.7048 54.6992 75.1575 54.8708 75.5265C55.0446 75.8955 55.2817 76.1744 55.582 76.3632C55.8824 76.552 56.2203 76.6464 56.5958 76.6464C56.8039 76.6464 57.0013 76.6185 57.1879 76.5628C57.3767 76.5048 57.5473 76.4201 57.6996 76.3085C57.8519 76.197 57.9807 76.0607 58.0858 75.8998C58.1931 75.7368 58.2671 75.5501 58.3079 75.3398L59.3119 75.3431C59.2583 75.667 59.1542 75.9653 58.9998 76.2377C58.8474 76.5081 58.6511 76.7419 58.4108 76.9393C58.1727 77.1345 57.9002 77.2858 57.5934 77.3931C57.2866 77.5003 56.9519 77.554 56.5893 77.554C56.0186 77.554 55.5101 77.4188 55.0639 77.1485C54.6176 76.876 54.2658 76.4866 54.0083 75.9803C53.753 75.4739 53.6253 74.87 53.6253 74.1684C53.6253 73.4647 53.7541 72.8607 54.0115 72.3566C54.269 71.8502 54.6208 71.4619 55.0671 71.1916C55.5134 70.9191 56.0208 70.7828 56.5893 70.7828C56.939 70.7828 57.2651 70.8333 57.5677 70.9341C57.8723 71.0328 58.1459 71.1787 58.3883 71.3718C58.6307 71.5627 58.8313 71.7966 58.9901 72.0734C59.1489 72.348 59.2562 72.6623 59.3119 73.0163ZM61.3869 70.873V77.4639H60.4246V70.873H61.3869ZM62.6814 77.4639V72.5207H63.6437V77.4639H62.6814ZM63.1674 71.758C63 71.758 62.8563 71.7022 62.7361 71.5906C62.6181 71.4769 62.5591 71.3417 62.5591 71.1851C62.5591 71.0264 62.6181 70.8912 62.7361 70.7796C62.8563 70.6659 63 70.6091 63.1674 70.6091C63.3347 70.6091 63.4774 70.6659 63.5954 70.7796C63.7155 70.8912 63.7756 71.0264 63.7756 71.1851C63.7756 71.3417 63.7155 71.4769 63.5954 71.5906C63.4774 71.7022 63.3347 71.758 63.1674 71.758ZM67.0204 77.5636C66.5419 77.5636 66.13 77.4553 65.7846 77.2386C65.4413 77.0198 65.1774 76.7183 64.9929 76.3343C64.8084 75.9502 64.7161 75.5104 64.7161 75.0148C64.7161 74.5128 64.8105 74.0697 64.9993 73.6857C65.1881 73.2995 65.4542 72.9981 65.7974 72.7814C66.1407 72.5647 66.5451 72.4563 67.0107 72.4563C67.3862 72.4563 67.7209 72.526 68.0148 72.6655C68.3087 72.8028 68.5458 72.9959 68.726 73.2448C68.9084 73.4937 69.0167 73.7844 69.0511 74.1169H68.1146C68.0631 73.8852 67.9451 73.6857 67.7606 73.5183C67.5782 73.351 67.3336 73.2673 67.0268 73.2673C66.7586 73.2673 66.5237 73.3381 66.322 73.4797C66.1225 73.6192 65.9669 73.8187 65.8554 74.0783C65.7438 74.3358 65.688 74.6404 65.688 74.9923C65.688 75.3527 65.7427 75.6638 65.8522 75.9256C65.9616 76.1873 66.1161 76.3901 66.3156 76.5338C66.5173 76.6775 66.7543 76.7494 67.0268 76.7494C67.2092 76.7494 67.3744 76.7162 67.5224 76.6497C67.6726 76.581 67.7981 76.4834 67.8989 76.3568C68.0019 76.2302 68.0738 76.0779 68.1146 75.8998H69.0511C69.0167 76.2195 68.9127 76.5048 68.7389 76.7559C68.5651 77.0069 68.3323 77.2043 68.0405 77.348C67.7509 77.4918 67.4108 77.5636 67.0204 77.5636ZM70.9651 75.7872L70.9587 74.6125H71.126L73.0956 72.5207H74.2477L72.0014 74.9022H71.8501L70.9651 75.7872ZM70.0801 77.4639V70.873H71.0423V77.4639H70.0801ZM73.2018 77.4639L71.4317 75.1146L72.0947 74.442L74.3828 77.4639H73.2018ZM79.8305 72.5207V73.2931H77.1304V72.5207H79.8305ZM77.8545 71.3364H78.8167V76.0125C78.8167 76.1991 78.8446 76.3396 78.9004 76.434C78.9562 76.5263 79.0281 76.5896 79.116 76.6239C79.2061 76.6561 79.3038 76.6722 79.4089 76.6722C79.4861 76.6722 79.5537 76.6668 79.6116 76.6561C79.6696 76.6454 79.7146 76.6368 79.7468 76.6303L79.9206 77.4252C79.8648 77.4467 79.7854 77.4682 79.6824 77.4896C79.5795 77.5132 79.4507 77.5261 79.2963 77.5282C79.0431 77.5325 78.8071 77.4875 78.5883 77.3931C78.3694 77.2987 78.1924 77.1528 78.0572 76.9554C77.9221 76.758 77.8545 76.5102 77.8545 76.212V71.3364ZM82.924 77.5636C82.4606 77.5636 82.0561 77.4574 81.7107 77.245C81.3653 77.0326 81.0971 76.7355 80.9062 76.3536C80.7152 75.9717 80.6198 75.5254 80.6198 75.0148C80.6198 74.502 80.7152 74.0536 80.9062 73.6696C81.0971 73.2855 81.3653 72.9873 81.7107 72.7749C82.0561 72.5625 82.4606 72.4563 82.924 72.4563C83.3874 72.4563 83.7918 72.5625 84.1373 72.7749C84.4827 72.9873 84.7509 73.2855 84.9418 73.6696C85.1328 74.0536 85.2282 74.502 85.2282 75.0148C85.2282 75.5254 85.1328 75.9717 84.9418 76.3536C84.7509 76.7355 84.4827 77.0326 84.1373 77.245C83.7918 77.4574 83.3874 77.5636 82.924 77.5636ZM82.9272 76.7559C83.2276 76.7559 83.4765 76.6765 83.6738 76.5177C83.8712 76.3589 84.0171 76.1476 84.1115 75.8837C84.2081 75.6198 84.2563 75.3291 84.2563 75.0116C84.2563 74.6962 84.2081 74.4066 84.1115 74.1427C84.0171 73.8766 83.8712 73.6632 83.6738 73.5022C83.4765 73.3413 83.2276 73.2609 82.9272 73.2609C82.6247 73.2609 82.3737 73.3413 82.1741 73.5022C81.9768 73.6632 81.8298 73.8766 81.7333 74.1427C81.6389 74.4066 81.5917 74.6962 81.5917 75.0116C81.5917 75.3291 81.6389 75.6198 81.7333 75.8837C81.8298 76.1476 81.9768 76.3589 82.1741 76.5177C82.3737 76.6765 82.6247 76.7559 82.9272 76.7559ZM91.832 75.4139V72.5207H92.7975V77.4639H91.8513V76.6078H91.7998C91.6861 76.8717 91.5038 77.0916 91.2527 77.2676C91.0039 77.4413 90.6938 77.5282 90.3227 77.5282C90.0051 77.5282 89.7241 77.4585 89.4795 77.319C89.2371 77.1774 89.0461 76.9683 88.9067 76.6915C88.7694 76.4147 88.7007 76.0725 88.7007 75.6649V72.5207H89.6629V75.549C89.6629 75.8859 89.7563 76.1541 89.9429 76.3536C90.1296 76.5531 90.372 76.6529 90.6702 76.6529C90.8505 76.6529 91.0296 76.6078 91.2077 76.5177C91.3879 76.4276 91.537 76.2914 91.655 76.109C91.7752 75.9266 91.8342 75.6949 91.832 75.4139ZM94.0904 79.3176V72.5207H95.0301V73.322H95.1106C95.1664 73.219 95.2468 73.1 95.3519 72.9648C95.4571 72.8296 95.603 72.7116 95.7896 72.6108C95.9763 72.5078 96.223 72.4563 96.5298 72.4563C96.9289 72.4563 97.285 72.5572 97.5983 72.7588C97.9115 72.9605 98.1572 73.2512 98.3352 73.631C98.5155 74.0107 98.6056 74.4677 98.6056 75.0019C98.6056 75.5362 98.5165 75.9942 98.3385 76.3761C98.1604 76.7559 97.9158 77.0487 97.6047 77.2547C97.2936 77.4585 96.9385 77.5604 96.5395 77.5604C96.2391 77.5604 95.9934 77.51 95.8025 77.4092C95.6137 77.3083 95.4657 77.1903 95.3584 77.0552C95.2511 76.92 95.1685 76.7998 95.1106 76.6947H95.0527V79.3176H94.0904ZM95.0333 74.9923C95.0333 75.3398 95.0838 75.6445 95.1846 75.9062C95.2854 76.168 95.4313 76.3729 95.6223 76.5209C95.8132 76.6668 96.0471 76.7398 96.3238 76.7398C96.6113 76.7398 96.8516 76.6636 97.0447 76.5113C97.2378 76.3568 97.3837 76.1476 97.4824 75.8837C97.5832 75.6198 97.6337 75.3227 97.6337 74.9923C97.6337 74.6662 97.5843 74.3733 97.4856 74.1137C97.3891 73.8541 97.2432 73.6492 97.0479 73.499C96.8549 73.3488 96.6135 73.2737 96.3238 73.2737C96.0449 73.2737 95.8089 73.3456 95.6158 73.4894C95.4249 73.6331 95.2801 73.8337 95.1814 74.0912C95.0827 74.3486 95.0333 74.649 95.0333 74.9923ZM100.646 70.873V77.4639H99.6837V70.873H100.646ZM104.023 77.5636C103.559 77.5636 103.155 77.4574 102.809 77.245C102.464 77.0326 102.196 76.7355 102.005 76.3536C101.814 75.9717 101.718 75.5254 101.718 75.0148C101.718 74.502 101.814 74.0536 102.005 73.6696C102.196 73.2855 102.464 72.9873 102.809 72.7749C103.155 72.5625 103.559 72.4563 104.023 72.4563C104.486 72.4563 104.89 72.5625 105.236 72.7749C105.581 72.9873 105.85 73.2855 106.04 73.6696C106.231 74.0536 106.327 74.502 106.327 75.0148C106.327 75.5254 106.231 75.9717 106.04 76.3536C105.85 76.7355 105.581 77.0326 105.236 77.245C104.89 77.4574 104.486 77.5636 104.023 77.5636ZM104.026 76.7559C104.326 76.7559 104.575 76.6765 104.772 76.5177C104.97 76.3589 105.116 76.1476 105.21 75.8837C105.307 75.6198 105.355 75.3291 105.355 75.0116C105.355 74.6962 105.307 74.4066 105.21 74.1427C105.116 73.8766 104.97 73.6632 104.772 73.5022C104.575 73.3413 104.326 73.2609 104.026 73.2609C103.723 73.2609 103.472 73.3413 103.273 73.5022C103.075 73.6632 102.928 73.8766 102.832 74.1427C102.737 74.4066 102.69 74.6962 102.69 75.0116C102.69 75.3291 102.737 75.6198 102.832 75.8837C102.928 76.1476 103.075 76.3589 103.273 76.5177C103.472 76.6765 103.723 76.7559 104.026 76.7559ZM108.839 77.5733C108.526 77.5733 108.243 77.5154 107.99 77.3995C107.737 77.2815 107.536 77.1109 107.388 76.8878C107.242 76.6647 107.169 76.3911 107.169 76.0672C107.169 75.7882 107.223 75.5587 107.33 75.3785C107.437 75.1982 107.582 75.0556 107.765 74.9504C107.947 74.8453 108.151 74.7659 108.376 74.7123C108.601 74.6587 108.831 74.6179 109.065 74.59C109.361 74.5557 109.601 74.5278 109.786 74.5063C109.97 74.4827 110.104 74.4452 110.188 74.3937C110.272 74.3422 110.313 74.2585 110.313 74.1427V74.1201C110.313 73.8391 110.234 73.6213 110.075 73.4668C109.919 73.3124 109.685 73.2351 109.374 73.2351C109.05 73.2351 108.794 73.307 108.608 73.4508C108.423 73.5924 108.296 73.75 108.225 73.9238L107.32 73.7179C107.428 73.4175 107.584 73.1751 107.79 72.9905C107.998 72.8039 108.238 72.6687 108.508 72.585C108.778 72.4992 109.063 72.4563 109.361 72.4563C109.558 72.4563 109.767 72.4799 109.988 72.5271C110.212 72.5722 110.42 72.6559 110.613 72.7781C110.808 72.9004 110.968 73.0753 111.092 73.3027C111.217 73.528 111.279 73.8208 111.279 74.1813V77.4639H110.339V76.788H110.301C110.238 76.9125 110.145 77.0348 110.021 77.1549C109.896 77.2751 109.736 77.3748 109.541 77.4542C109.346 77.5336 109.112 77.5733 108.839 77.5733ZM109.049 76.8009C109.315 76.8009 109.542 76.7484 109.731 76.6432C109.922 76.5381 110.067 76.4008 110.165 76.2313C110.266 76.0597 110.317 75.8762 110.317 75.681V75.0438C110.282 75.0781 110.216 75.1103 110.117 75.1403C110.021 75.1682 109.91 75.1929 109.786 75.2143C109.661 75.2336 109.54 75.2519 109.422 75.269C109.304 75.2841 109.205 75.2969 109.126 75.3077C108.939 75.3313 108.769 75.371 108.614 75.4267C108.462 75.4825 108.34 75.563 108.247 75.6681C108.157 75.7711 108.112 75.9084 108.112 76.08C108.112 76.3182 108.2 76.4984 108.376 76.6207C108.552 76.7408 108.776 76.8009 109.049 76.8009ZM114.411 77.5604C114.012 77.5604 113.656 77.4585 113.343 77.2547C113.031 77.0487 112.787 76.7559 112.609 76.3761C112.433 75.9942 112.345 75.5362 112.345 75.0019C112.345 74.4677 112.434 74.0107 112.612 73.631C112.792 73.2512 113.039 72.9605 113.352 72.7588C113.665 72.5572 114.021 72.4563 114.417 72.4563C114.724 72.4563 114.971 72.5078 115.158 72.6108C115.346 72.7116 115.492 72.8296 115.595 72.9648C115.7 73.1 115.782 73.219 115.84 73.322H115.898V70.873H116.86V77.4639H115.92V76.6947H115.84C115.782 76.7998 115.698 76.92 115.589 77.0552C115.482 77.1903 115.334 77.3083 115.145 77.4092C114.956 77.51 114.711 77.5604 114.411 77.5604ZM114.623 76.7398C114.9 76.7398 115.134 76.6668 115.325 76.5209C115.518 76.3729 115.664 76.168 115.763 75.9062C115.864 75.6445 115.914 75.3398 115.914 74.9923C115.914 74.649 115.865 74.3486 115.766 74.0912C115.667 73.8337 115.522 73.6331 115.331 73.4894C115.14 73.3456 114.904 73.2737 114.623 73.2737C114.334 73.2737 114.092 73.3488 113.899 73.499C113.706 73.6492 113.56 73.8541 113.462 74.1137C113.365 74.3733 113.317 74.6662 113.317 74.9923C113.317 75.3227 113.366 75.6198 113.465 75.8837C113.564 76.1476 113.709 76.3568 113.903 76.5113C114.098 76.6636 114.338 76.7398 114.623 76.7398Z"
                      fill="#aaa"
                    />
                    <path
                      d="M53.1136 79.2661H117.584V79.884H53.1136V79.2661Z"
                      fill="#111827"
                    />
                  </>
                )}
              </svg>
            </div>
            <input
              type="file"
              accept=".png, .jpg, .jpeg"
              multiple
              onChange={handleFileChange}
              onDrop={handleDrop}
            />

            {image && (
              <div className="preview_selImage ">
                <img className="" src={image} alt="Selected" />
              </div>
            )}
            {/* <p className="mb-0">{Image ? "1 file selected" : "No file selected"}</p> */}
          </div>
        </div>
        <button type="submit">{initialTitle ? "Update" : "Create"}</button>
      </form>
    </>
  );
}
